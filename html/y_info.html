<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>
        个人资料
    </title>
    <meta content="" name="keywords">
    <meta content="" name="description">
    <meta content="webkit" name="renderer">
    <meta content="no-siteapp" http-equiv="Cache-Control" />
    <meta content="yes" name="mobile-web-app-capable" />
    <meta content="yes" name="apple-mobile-web-app-capable" />
    <meta content="black" name="apple-mobile-web-app-status-bar-style" />
    <meta content="telephone=no,email=no,address=no" name="format-detection" />
    <meta content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport" />
    <link href="../css/common.css" rel="stylesheet" />
    <script src="../js/adaptive.js" type="text/javascript"></script>
    <script src="../js/jquery-1.8.3.min.js" type="text/javascript"></script>
    <script>
    window['adaptive'].desinWidth = 750;
    window['adaptive'].baseFont = 28;
    window['adaptive'].init();
    </script>
    <style type="text/css">
    .avatar {
        width: 1.06rem;
        height: 1.06rem;
    }

    .arrow {
        width: 0.16rem;
        height: 0.28rem;
    }

    .maskHide-btn {
        position: absolute;
        right: 0.1rem;
        top: 0.1rem;
        width: 0.55rem;
        height: 0.55rem;
        font-size: 0.50rem;
        font-weight: lighter;
        color: #fff;
        background: transparent;
    }

    .mask_name,
    .mask_phone {
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        position: fixed;
        top: 0px;
        left: 0px;
        display: none;
    }

    .modal-pane,
    .modal-phone {
        width: 80%;
        margin: 0 auto;
        margin-top: 200px;
        border-radius: 5px;
    }

    .modal-pane ul,
    .modal-phone ul {
        padding: 0.2rem
    }

    #nickname {
        border: 1px solid #dadada;
        text-indent: .3rem;
        border-radius: 3px;
    }
    </style>
</head>

<body>
    <!-- 主体部分 -->
    <div class="container">
        <ul>
            <li>
                <form method="post" enctype="multipart/form-data" id="form">
                    <label class="mtb24 p30 bw flex_a flex-sb">
                        <input type="hidden" hidden name="userId" id="userId" />
                        <input type="file" name="file" id="file" hidden="">
                        <span class="pl8 font14">头像</span>
                        <div class="flex img-pane">
                            <img src="" alt="" class="avatar br-circle mr10 pic" style="width: .8rem;height: .8rem;border-radius: 50%" />
                            <img src="../img/y_arrow_right.png" height="20" width="12" alt="" class="arrow">
                        </div>
                    </label>
                </form>
            </li>
            <li class="mt20">
                <a href="javascript:void(0)" onclick="showName();" class="p30 bw bdb flex_a flex-sb">
        <span class="pl8 font14">昵称</span>
        <div class="flex">
          <span class="c9 pr12 nickName mr10 col9"><!-- Jacket --></span>
          <img src="../img/y_arrow_right.png" alt="" class="arrow">
        </div>
      </a>
            </li>
            <li>
                <a class="p30 bw bdb flex_a flex-sb" id="mPhone">
        <span class="pl8 font14">手机</span>
        <div class="flex">
          <span class="c9 pr12 phone mr10 col9"><!-- 15816487544 --></span>
          <img src="../img/y_arrow_right.png" alt="" class="arrow">
        </div>
      </a>
            </li>
            <li>
                <a class="p30 bw bdb flex_a flex-sb" id="mPhone">
        <span class="pl8 font14">实名认证</span>
        <div class="flex">
          <span class="c9 pr12 rz mr10 col9 certification"><!-- 15816487544 --></span>
          <img src="../img/y_arrow_right.png" alt="" class="arrow">
        </div>
      </a>
            </li>
        </ul>
        <div class="mask_name flex pos_r" style="display:none;">
            <div class="modal-pane bw border-r2 plr30 w80 flex_sb" style="">
                <ul>
                    <button class="maskHide-btn" onclick="hideModal('.mask_name');">×</button>
                    <p>修改昵称</p>
                    <input type="text" name="text" placeholder="请输入新的昵称" id="nickname" class="w100 mt30 mb20  ptb4 lh100" maxlength="6">
                </ul>
                <div class="flex-center flex">
                    <button type="button" class="btn cf f16 w100 p30 tac w50" onclick="hideModal('.mask_name');" style="background: #F4F4F4;border-bottom-left-radius: 5px;">取消</button>
                    <button type="button" class="btn cf f16 w100 p30 tac colw w50" onclick="nickname()" style="background: linear-gradient(to right,#6c8eda,#4bc0ed);border-bottom-right-radius: 5px;">确认</button>
                </div>
            </div>
        </div>
        <div class="mask_phone flex pos_r">
            <div class="modal-phone bw border-r2 plr30 w80 flex_sb" style="">
                <ul>
                    <button class="maskHide-btn" onclick="hideM()">×</button>
                    <p>修改手机号码</p>
                    <input type="num" name="text" placeholder="请输入新的手机号码" id="mobile" class="w100 mt30 mb20  ptb4 lh100" maxlength="11">
                </ul>
                <div class="flex-center flex">
                    <button type="button" class="btn cf f16 w100 p30 tac w50" onclick="hideM()" style="background: #F4F4F4;border-bottom-left-radius: 5px;">取消</button>
                    <button type="button" class="btn cf f16 w100 p30 tac colw w50" onclick="changePhone()" style="background: linear-gradient(to right,#6c8eda,#4bc0ed);border-bottom-right-radius: 5px;">确认</button>
                </div>
            </div>
        </div>
    </div>
    <!-- 底部 -->
    <script type="text/javascript" src="../js/JForm.js"></script>
    <script type="text/javascript" src="../js/dlc.js"></script>
    <script type="text/javascript" src="../js/h_common.js"></script>
    <script type="text/javascript" src="../js/jquery.form.js"></script>
</body>

</html>
<script type="text/javascript">
addEventback();
$('#userId').val(user_token().USER_ID);
$(function() {
    // 获取个人信息
    dlc_request('appuser/findUser', { userId: user_token().USER_ID }, function(res) {
        console.log(res);
        if (res.code == 1) { //登录成功
            $('.avatar').attr('src', res.appUser.image.indexOf('http') != -1 ? res.appUser.image : 'https://mlxyhotel.https.xiaozhuschool.com/uploadFiles/uploadImgs/' + res.appUser.image);
            $(".nickName").text(res.appUser.USERNAME);
            $('.phone').text(res.appUser.PHONE ? res.appUser.PHONE : '未绑定');
            $('.certification').text(res.appUser.isrz == 0 ? '未认证' : '已认证')
        } else {
            dlctipbox.show(res.msg);
        }
    });

    $('#file').on('change', function() {
        var reader = new FileReader();
        reader.readAsDataURL(event.target.files[0]);
        reader.onload = function(e) {
            $('.avatar').attr('src', e.target.result);

        };
        formSubmit();
    })

})
// $('input[name=userId]').val() = getUrlParam('userId') * 1;

function formSubmit() {
    // 修改头像
    $('#form').ajaxSubmit({
        type: 'POST',
        url: dlcUrl() + 'appuser/saveImage',
        dataType: 'json',
        beforeSubmit: function() {
            var imgValue = $('#file').val();
            if (imgValue == '') {
                dlctipbox.show('请选择图片');
                return false;
            }
            loadingShow();
        },
        success: function(res) {
            loadingHide();
            if (res.code == 1) {
                dlctipbox.show('修改成功');

            } else {
                dlctipbox.show(res.msg);
            }
        }
    });
    return false; //阻止表单默认提交
}
//修改昵称
function showName () {
    $('.mask_name').show();
    $('.modal-pane').show();
}
function nickname() {
    if (isNull($('#nickname').val())) {
        dlctipbox.show('请输入新的昵称');
        return false;
    }
    $.ajax({
        type: 'post',
        url: dlcUrl() + 'appuser/updateUser',
        data: { userId: user_token().USER_ID, userName: $('#nickname').val().replace(/\s/g, "") },
        dataType: 'json',
        success: function(res) {
            console.log(res)
            hideModal('.modal-pane')
            if (res.code == '1') {
                dlctipbox.show('修改成功');
                $(".mask_name ").hide();
                $(".nickName").text($('#nickname').val().replace(/\s/g, ""))
            } else {
                dlctipbox.show(res.msg);
            }
        },
        error: function() {
            alert('网络异常,请刷新');
        }
    })
}
//修改手机号码

function changePhone() {
    if (isNull($('#mobile').val())) {
        dlctipbox.show('请输入新的手机号码');
        return false;
    } else if (!checkMobileAndTel($('#mobile').val())) {
        dlctipbox.show('请输入正确格式的手机号码');
    } else if (localStorage.getItem('oldP') == $('#mobile').val()) {
        dlctipbox.show('手机号码不能重复')
    } else {
        $.ajax({
            type: 'post',
            url: dlcUrl() + 'Wxsite/home/index',
            data: { api_name: 'mobile', mobile: $('#mobile').val().replace(/\s/g, "") },
            dataType: 'json',
            success: function(res) {
                console.log(res);
                hideModal('.mask_phone');
                if (res.code == '1') {
                    dlctipbox.show('修改成功');
                    $(".phone").text($('#mobile').val().replace(/\s/g, ""))
                } else {
                    dlctipbox.show(res.msg);
                }

            },
            error: function() {
                alert('网络异常,请刷新');
            }
        })
    }
}
// 按钮隐藏
function hideM() {
    $('.mask_phone').hide()
}
</script>